{% extends "base.html" %} {% block title %}AutoVPN - User Panel{% endblock %} {%
block content %}
<div class="max-w-4xl mx-auto space-y-8">
  <h1 class="text-3xl font-bold text-gray-900">Generate VPN Profiles</h1>

  <!-- Password Verification -->
  <div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      Step 1: Verify Access
    </h2>
    <form
      hx-post="/api/auth/verify"
      hx-target="#password-result"
      class="space-y-4"
    >
      <input
        type="password"
        name="password"
        placeholder="Enter app password"
        class="w-full px-3 py-2 border border-gray-300 rounded-md"
        required
      />
      <button
        type="submit"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Verify Password
      </button>
    </form>
    <div id="password-result" class="mt-4"></div>
  </div>

  <!-- Automation Selection -->
  <div
    class="bg-white p-6 rounded-lg shadow-md"
    id="automation-section"
    style="display: none"
  >
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      Step 2: Select Automation
    </h2>
    <div
      hx-get="/api/user/automations"
      hx-trigger="load"
      hx-target="#automations-list"
      hx-indicator="#loading-indicator"
    ></div>
    <div id="loading-indicator" class="htmx-indicator">
      <p class="text-gray-500">Loading automations...</p>
    </div>
    <div id="automations-list"></div>
  </div>

  <!-- Login Selection -->
  <div
    class="bg-white p-6 rounded-lg shadow-md"
    id="login-section"
    style="display: none"
  >
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      Step 3: Select Login
    </h2>
    <div id="logins-list"></div>
  </div>

  <!-- Profile Generation -->
  <div
    class="bg-white p-6 rounded-lg shadow-md"
    id="generation-section"
    style="display: none"
  >
    <h2 class="text-xl font-semibold text-gray-800 mb-4">
      Step 4: Generate Profiles
    </h2>
    <form
      hx-post="/api/user/generate"
      hx-target="#generation-result"
      class="space-y-4"
    >
      <input type="hidden" id="selected-automation" name="automation_id" />
      <input type="hidden" id="selected-login" name="user_login_id" />

      <div>
        <label
          for="num-profiles"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Number of Profiles (1-100)
        </label>
        <input
          type="number"
          id="num-profiles"
          name="num_profiles"
          min="1"
          max="100"
          value="1"
          class="w-full px-3 py-2 border border-gray-300 rounded-md"
          required
        />
      </div>

      <button
        type="submit"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
      >
        Generate Profiles
      </button>
    </form>
    <div id="generation-result" class="mt-4"></div>
  </div>
</div>

<script>
  // Debug HTMX events
  document.body.addEventListener("htmx:beforeRequest", function (event) {
    console.log("HTMX beforeRequest:", event.detail.xhr.url);
  });

  document.body.addEventListener("htmx:afterRequest", function (event) {
    console.log(
      "HTMX afterRequest:",
      event.detail.xhr.url,
      event.detail.xhr.status
    );
    if (event.detail.xhr.responseURL.includes("/api/auth/verify")) {
      const response = JSON.parse(event.detail.xhr.responseText);
      if (response.valid) {
        document.getElementById("automation-section").style.display = "block";
      }
    }
  });

  document.body.addEventListener("htmx:responseError", function (event) {
    console.error(
      "HTMX responseError:",
      event.detail.xhr.url,
      event.detail.xhr.status
    );
  });

  // Handle automation selection
  document.body.addEventListener("click", function (event) {
    console.log("Click event detected:", event.target);

    // Find the closest element with select-automation class
    const automationButton = event.target.closest(".select-automation");
    if (automationButton) {
      console.log("Automation button clicked:", automationButton);
      const automationId = automationButton.dataset.automationId;
      console.log("Automation ID:", automationId);
      document.getElementById("selected-automation").value = automationId;
      document.getElementById("login-section").style.display = "block";

      // Load logins for this automation
      htmx.ajax("GET", `/api/user/automations/${automationId}/logins`, {
        target: "#logins-list",
      });
    }

    // Find the closest element with select-login class
    const loginButton = event.target.closest(".select-login");
    if (loginButton) {
      console.log("Login button clicked:", loginButton);
      const loginId = loginButton.dataset.loginId;
      console.log("Login ID:", loginId);
      document.getElementById("selected-login").value = loginId;
      document.getElementById("generation-section").style.display = "block";
    }
  });

  // Function to check generation status
  function checkStatus(requestId) {
    htmx.ajax("GET", `/api/user/requests/${requestId}/status`, {
      target: "#generation-result",
    });
  }

  // Auto-refresh status every 5 seconds for running requests
  setInterval(function () {
    const resultDiv = document.getElementById("generation-result");
    if (resultDiv && resultDiv.innerHTML.includes("Status: Running")) {
      // Extract request ID from the result div
      const match = resultDiv.innerHTML.match(/Request #(\d+)/);
      if (match) {
        const requestId = match[1];
        checkStatus(requestId);
      }
    }
  }, 5000);
</script>
{% endblock %}
